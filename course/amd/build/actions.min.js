define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/yui","core/modal_factory","core/modal_events","core/key_codes"],function(e,t,n,o,i,a,r,c,s,u){var d="editinprogress",l="editing_move",f={ACTIVITYLI:"li.activity",ACTIONAREA:".actions",ACTIVITYACTION:"a.cm-edit-action",MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",TOGGLE:".toggle-display,.dropdown-toggle",SECTIONLI:"li.section",SECTIONACTIONMENU:".section_action_menu",ADDSECTIONS:"#changenumsections [data-add-sections]"};r.use("moodle-course-coursebase",function(){var e=M.course.format.get_section_selector();e&&(f.SECTIONLI=e)});var m=function(e){var t;return r.use("moodle-course-util",function(n){t=n.Moodle.core_course.util.cm.getId(n.Node(e.get(0)))}),t},v=function(e){e.addClass(d);var t=e.find(f.ACTIONAREA).get(0);if(t){var n=M.util.add_spinner(r,r.Node(t));return n.show(),n}return null},h=function(e){var t=M.util.add_lightbox(r,r.Node(e.get(0)));return t.show(),t},p=function(e,t,n){window.setTimeout(function(){e.removeClass(d),t&&t.hide()},n)},g=function(e,t){e&&window.setTimeout(function(){e.hide()},t)},I=function(e,t){if(r.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+e)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(r.one("#"+e)),t){var n=r.one("#"+e+" "+f.MENU).one(f.TOGGLE);n&&n.simulate&&n.simulate("click")}},T=function(n,i,a){var r,c=a.attr("data-keepopen"),s=a.attr("data-action"),u=v(n),d=t.call([{methodname:"core_course_edit_module",args:{id:i,action:s,sectionreturn:a.attr("data-sectionreturn")?a.attr("data-sectionreturn"):0}}],!0);"duplicate"===s&&(r=h(a.closest(f.SECTIONLI))),e.when.apply(e,d).done(function(t){var o,i,a,d=(o=n,i=!1,a=null,e("a:visible").each(function(){if(e.contains(o[0],this))i=!0;else if(i)return a=this,!1}),a);n.replaceWith(t),e("<div>"+t+"</div>").find(f.ACTIVITYLI).each(function(t){var n,o,i,a;I(e(this).attr("id"),c),0===t&&(n=e(this).attr("id"),o=s,i=e("#"+n),a="[data-action="+o+"]","groupsseparate"!==o&&"groupsvisible"!==o&&"groupsnone"!==o||(a="[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]"),i.find(a).is(":visible")?i.find(a).focus():i.find(f.MENU).find(f.TOGGLE).focus(),d=null)}),d&&d.focus(),p(n,u,400),g(r,400),n.trigger(e.Event("coursemoduleedited",{ajaxreturn:t,action:s}))}).fail(function(t){p(n,u),g(r);var i=e.Event("coursemoduleeditfailed",{exception:t,action:s});n.trigger(i),i.isDefaultPrevented()||o.exception(t)})},C=function(e,t){var n,a,c=e.attr("class").match(/modtype_([^\s]*)/)[1],s=(n=e,r.use("moodle-course-util",function(e){a=e.Moodle.core_course.util.cm.getName(e.Node(n.get(0)))}),a);i.get_string("pluginname",c).done(function(e){var n={type:e,name:s};i.get_strings([{key:"confirm"},{key:null===s?"deletechecktype":"deletechecktypename",param:n},{key:"yes"},{key:"no"}]).done(function(e){o.confirm(e[0],e[1],e[2],e[3],t)})})},N=function(e,t,a,r,c,s,u){var d=[{key:a,component:r}];return c&&d.push({key:c,component:s}),i.get_strings(d).then(function(o){e.find("span.menu-action-text").html(o[0]),e.attr("title",o[0]);var i="";return c&&(i=o[1],e.attr("title",i)),n.renderPix(t,"core",i)}).then(function(t){e.find(".icon").replaceWith(t),e.attr("data-action",u)}).catch(o.exception)},_=function(t){e("<div>"+t+"</div>").find(f.ACTIVITYLI).each(function(){var n=e(this).attr("id");e(f.ACTIVITYLI+"#"+n).replaceWith(t),I(n,!1)})},y=function(n,i,a,c){var s=a.attr("data-action"),u=a.attr("data-sectionreturn")?a.attr("data-sectionreturn"):0,l=function(e){e.addClass(d);var t=e.find(f.SECTIONACTIONMENU).get(0);if(t){var n=M.util.add_spinner(r,r.Node(t));return n.show(),n}return null}(n),m=t.call([{methodname:"core_course_edit_section",args:{id:i,action:s,sectionreturn:u}}],!0),v=h(n);e.when.apply(e,m).done(function(t){var o=e.parseJSON(t);p(n,l),g(v),n.find(f.SECTIONACTIONMENU).find(f.TOGGLE).focus();var i=e.Event("coursesectionedited",{ajaxreturn:o,action:s});n.trigger(i),i.isDefaultPrevented()||function(t,n,o,i){var a=n.attr("data-action");if("hide"===a||"show"===a){if("hide"===a?(t.addClass("hidden"),N(n,"i/show","showfromothers","format_"+i,null,null,"show")):(t.removeClass("hidden"),N(n,"i/hide","hidefromothers","format_"+i,null,null,"hide")),void 0!==o.modules)for(var r in o.modules)_(o.modules[r]);void 0!==o.section_availability&&t.find(".section_availability").first().replaceWith(o.section_availability)}else if("setmarker"===a){var c=e(f.SECTIONLI+".current"),s=c.find(f.SECTIONACTIONMENU+" a[data-action=removemarker]");c.removeClass("current"),N(s,"i/marker","highlight","core","markthistopic","core","setmarker"),t.addClass("current"),N(n,"i/marked","highlightoff","core","markedthistopic","core","removemarker")}else"removemarker"===a&&(t.removeClass("current"),N(n,"i/marker","highlight","core","markthistopic","core","setmarker"))}(n,a,o,c)}).fail(function(t){p(n,l),g(v);var i=e.Event("coursesectioneditfailed",{exception:t,action:s});n.trigger(i),i.isDefaultPrevented()||o.exception(t)})};return r.use("moodle-course-coursebase",function(){M.course.coursebase.register_module({set_visibility_resource_ui:function(n){var o,i,a,r,c,s=e(n.element.getDOMNode()),u=m(s);if(u){var d=s.find("."+l).attr("data-sectionreturn");i=u,a=d,r=v(o=s),c=t.call([{methodname:"core_course_get_module",args:{id:i,sectionreturn:a}}],!0),e.when.apply(e,c).done(function(e){p(o,r,400),_(e)}).fail(function(){p(o,r)})}}})}),{initCoursePage:function(t){e("body").on("click keypress",f.ACTIVITYLI+" "+f.ACTIVITYACTION+"[data-action]",function(t){if("keypress"!==t.type||13===t.keyCode){var n=e(this),o=n.closest(f.ACTIVITYLI),i=n.attr("data-action"),a=m(o);switch(i){case"moveleft":case"moveright":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return}a&&(t.preventDefault(),"delete"===i?C(o,function(){T(o,a,n)}):T(o,a,n))}}),e("body").on("click keypress",f.SECTIONLI+" "+f.SECTIONACTIONMENU+"[data-sectionid] a[data-action]",function(n){if("keypress"!==n.type||13===n.keyCode){var a,r,c=e(this),s=c.closest(f.SECTIONLI),u=c.closest(f.SECTIONACTIONMENU).attr("data-sectionid");n.preventDefault(),c.attr("data-confirm")?(a=c.attr("data-confirm"),r=function(){y(s,u,c,t)},i.get_strings([{key:"confirm"},{key:"yes"},{key:"no"}]).done(function(e){o.confirm(e[0],a,e[1],e[2],r)})):y(s,u,c,t)}}),i.get_string("numberweeks").done(function(t){var n=e(f.ADDSECTIONS),o=n.attr("data-add-sections"),i=e('<div><label for="add_section_numsections"></label> <input id="add_section_numsections" type="number" min="1" value="1"></div>');i.find("label").html(t),c.create({title:o,type:c.types.SAVE_CANCEL,body:i.html()},n).done(function(t){var i=e(t.getBody()).find("#add_section_numsections"),a=function(){""+parseInt(i.val())===i.val()&&parseInt(i.val())>=1&&(document.location=n.attr("href")+"&numsections="+parseInt(i.val()))};t.setSaveButtonText(o),t.getRoot().on(s.shown,function(){i.focus().select().on("keydown",function(e){e.keyCode===u.enter&&a()})}),t.getRoot().on(s.save,function(e){e.preventDefault(),a()})})})},replaceSectionActionItem:function(e,t,n,o,i,a,r,c){var s=e.find(f.SECTIONACTIONMENU+" "+t);N(s,n,o,i,a,r,c)}}});