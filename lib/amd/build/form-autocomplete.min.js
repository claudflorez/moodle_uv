'use strict';define(['jquery','core/log','core/str','core/templates','core/notification'],function(a,b,c,d,f){var g={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:44,UP:38},h=a.now(),i=function(x,y){var z=a(document.getElementById(y.selectionId)),A=z.children('[aria-selected=true]').length;for(x%=A;0>x;)x+=A;var B=a(z.children('[aria-selected=true]').get(x)),C=y.selectionId+'-'+x;z.children().attr('data-active-selection',!1).attr('id',''),B.attr('data-active-selection',!0).attr('id',C),z.attr('aria-activedescendant',C)},j=function(x,y,z){var A=[],B=a(document.getElementById(y.selectionId)),C=B.attr('aria-activedescendant'),D=!1,E=a(document.getElementById(y.inputId));E.val(''),C&&(D=a(document.getElementById(C)).attr('data-value')),z.children('option').each(function(G,H){if(a(H).prop('selected')){var I;I=a(H).data('html')?a(H).data('html'):a(H).html(),A.push({label:I,value:a(H).attr('value')})}});var F=a.extend({items:A},x,y);d.render('core/form_autocomplete_selection',F).done(function(G){B.empty().append(a(G).html()),r(y),!1!=D&&B.children('[aria-selected=true]').each(function(H,I){a(I).attr('data-value')===D&&i(H,y)})}).fail(f.exception)},k=function(x){'undefined'!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed(),x.change()},l=function(x,y,z,A){var B=a(z).attr('data-value');x.multiple&&A.children('option').each(function(C,D){a(D).attr('value')==B&&(a(D).prop('selected',!1),a(D).attr('data-iscustom')&&a(D).remove())}),j(x,y,A),k(A)},m=function(x,y){var z=a(document.getElementById(y.inputId)),A=a(document.getElementById(y.suggestionsId)),B=A.children('[aria-hidden=false]').length;for(x%=B;0>x;)x+=B;var C=a(A.children('[aria-hidden=false]').get(x)),D=a(A.children('[role=option]')).index(C),E=y.suggestionsId+'-'+D;A.children().attr('aria-selected',!1).attr('id',''),C.attr('aria-selected',!0).attr('id',E),z.attr('aria-activedescendant',E);var F=C.offset().top-A.offset().top+A.scrollTop()-A.height()/2;A.animate({scrollTop:F},100)},n=function(x){var y=a(document.getElementById(x.suggestionsId)),z=y.children('[aria-selected=true]'),A=y.children('[aria-hidden=false]').index(z);m(A+1,x)},o=function(x){var y=a(document.getElementById(x.selectionId)),z=y.children('[data-active-selection=true]');if(!z)return void i(0,x);var A=y.children('[aria-selected=true]').index(z);i(A-1,x)},p=function(x){var y=a(document.getElementById(x.selectionId)),z=y.children('[data-active-selection=true]');if(!z)return void i(0,x);var A=y.children('[aria-selected=true]').index(z);i(A+1,x)},q=function(x){var y=a(document.getElementById(x.suggestionsId)),z=y.children('[aria-selected=true]'),A=y.children('[aria-hidden=false]').index(z);m(A-1,x)},r=function(x){var y=a(document.getElementById(x.inputId)),z=a(document.getElementById(x.suggestionsId));y.attr('aria-expanded',!1).attr('aria-activedescendant',x.selectionId),z.hide().attr('aria-hidden',!0)},s=function(x,y,z,A){var B=a(document.getElementById(y.inputId)),C=a(document.getElementById(y.suggestionsId)),D=!1,E=[];A.children('option').each(function(H,I){!0!==a(I).prop('selected')&&(E[E.length]={label:I.innerHTML,value:a(I).attr('value')})});var F=y.caseSensitive?z:z.toLocaleLowerCase(),G=a.extend({options:E},x,y);d.render('core/form_autocomplete_suggestions',G).done(function(H){C.replaceWith(H),C=a(document.getElementById(y.suggestionsId)),C.show().attr('aria-hidden',!1),C.children().each(function(I,J){J=a(J),x.caseSensitive&&-1<J.text().indexOf(F)||!x.caseSensitive&&-1<J.text().toLocaleLowerCase().indexOf(F)?(J.show().attr('aria-hidden',!1),D=!0):J.hide().attr('aria-hidden',!0)}),B.attr('aria-expanded',!0),A.attr('data-notice')?C.html(A.attr('data-notice')):D?!x.tags&&m(0,y):c.get_string('nosuggestions','form').done(function(I){C.html(I)})}).fail(f.exception)},t=function(x,y,z){var A=a(document.getElementById(y.inputId)),B=A.val(),C=B.split(','),D=!1;a.each(C,function(E,F){if(F=F.trim(),''!==F&&(x.multiple||z.children('option').prop('selected',!1),z.children('option').each(function(H,I){a(I).attr('value')==F&&(D=!0,a(I).prop('selected',!0))}),!D)){var G=a('<option>');G.append(document.createTextNode(F)),G.attr('value',F),z.append(G),G.prop('selected',!0),G.attr('data-iscustom',!0)}}),j(x,y,z),k(z),A.val(''),r(y)},u=function(x,y,z){var A=a(document.getElementById(y.inputId)),B=a(document.getElementById(y.suggestionsId)),C=B.children('[aria-selected=true]').attr('data-value');x.multiple||z.children('option').prop('selected',!1),z.children('option').each(function(D,E){a(E).attr('value')==C&&a(E).prop('selected',!0)}),j(x,y,z),k(z),x.closeSuggestionsOnSelect?(A.val(''),r(y)):(A.focus(),s(x,y,A.val(),z))},v=function(x,y,z,A,B){var C='form-autocomplete-updateajax';M.util.js_pending(C);var D=a(x.currentTarget).val();B.transport(y.selector,D,function(E){var F=B.processResults(y.selector,E),G=[];if(A.children('option').each(function(I,J){J=a(J),J.prop('selected')?G.push(J.attr('value')+''):J.remove()}),!y.multiple&&0===A.children('option').length){var H=a('<option>');A.append(H)}a.isArray(F)?(a.each(F,function(I,J){if(-1===G.indexOf(J.value+'')){var K=a('<option>');K.append(J.label),K.attr('value',J.value),A.append(K)}}),A.attr('data-notice','')):A.attr('data-notice',F),s(y,z,'',A),M.util.js_complete(C)},function(E){M.util.js_complete(C),f.exception(E)})},w=function(x,y,z){var A=a(document.getElementById(y.inputId));if(A.on('keydown',function(E){var F='form-autocomplete-addnav-'+y.inputId+'-'+E.keyCode;switch(M.util.js_pending(F),E.keyCode){case g.DOWN:return x.showSuggestions?('true'===A.attr('aria-expanded')?n(y):!A.val()&&x.ajax?require([x.ajax],function(H){v(E,x,y,z,H)}):s(x,y,A.val(),z),E.preventDefault(),M.util.js_complete(F),!1):(M.util.js_complete(F),!0);case g.UP:return q(y),E.preventDefault(),M.util.js_complete(F),!1;case g.ENTER:var G=a(document.getElementById(y.suggestionsId));return'true'===A.attr('aria-expanded')&&0<G.children('[aria-selected=true]').length?u(x,y,z):x.tags&&t(x,y,z),E.preventDefault(),M.util.js_complete(F),!1;case g.ESCAPE:return'true'===A.attr('aria-expanded')&&r(y),E.preventDefault(),M.util.js_complete(F),!1;}return M.util.js_complete(F),!0}),A.on('keypress',function(E){var F='form-autocomplete-keypress-'+E.keyCode;return(M.util.js_pending(F),E.keyCode===g.COMMA)?(x.tags&&t(x,y,z),E.preventDefault(),M.util.js_complete(F),!1):(M.util.js_complete(F),!0)}),A.on('behat:set-value',function(){var E=a(document.getElementById(y.suggestionsId)),F='form-autocomplete-behat';M.util.js_pending(F),'true'===A.attr('aria-expanded')&&0<E.children('[aria-selected=true]').length?u(x,y,z):x.tags&&t(x,y,z),M.util.js_complete(F)}),A.on('blur',function(){var E='form-autocomplete-blur';M.util.js_pending(E),window.setTimeout(function(){var F=a(document.activeElement);F.attr('id')!=A.attr('id')&&(x.tags&&t(x,y,z),r(y)),M.util.js_complete(E)},500)}),x.showSuggestions){var B=a(document.getElementById(y.downArrowId));B.on('click',function(E){var F='form-autocomplete-show-suggestions';M.util.js_pending(F),A.focus(),!A.val()&&x.ajax?require([x.ajax],function(G){v(E,x,y,z,G)}):s(x,y,A.val(),z),M.util.js_complete(F)})}var C=a(document.getElementById(y.suggestionsId));C.parent().on('click','[role=option]',function(E){var F='form-autocomplete-parent';M.util.js_pending(F);var G=a(E.currentTarget).closest('[role=option]'),H=a(document.getElementById(y.suggestionsId)),I=H.children('[aria-hidden=false]').index(G);m(I,y),u(x,y,z),M.util.js_complete(F)});var D=a(document.getElementById(y.selectionId));D.on('click','[role=listitem]',function(E){var F='form-autocomplete-clicks';M.util.js_pending(F);var G=a(E.currentTarget);l(x,y,G,z),M.util.js_complete(F)}),D.on('keydown',function(E){var F='form-autocomplete-keydown-'+E.keyCode;switch(M.util.js_pending(F),E.keyCode){case g.DOWN:return p(y),E.preventDefault(),M.util.js_complete(F),!1;case g.UP:return o(y),E.preventDefault(),M.util.js_complete(F),!1;case g.SPACE:case g.ENTER:var G=a(document.getElementById(y.selectionId)).children('[data-active-selection=true]');return G&&(l(x,y,G,z),E.preventDefault()),M.util.js_complete(F),!1;}return M.util.js_complete(F),!0}),x.showSuggestions&&(x.ajax?require([x.ajax],function(E){var F=null,G='autocomplete-throttledhandler',H=function(J){v(J,x,y,z,E),M.util.js_complete(G)};A.on('input',function I(J){null==F?M.util.js_pending(G):(window.clearTimeout(F),F=null),F=window.setTimeout(H.bind(this,J),300)})}):A.on('input',function(E){var F=a(E.currentTarget).val(),G=a(E.currentTarget).data('last-value');G!==F&&s(x,y,F,z),a(E.currentTarget).data('last-value',F)}))};return{enhance:function enhance(x,y,z,A,B,C,D,E){var F={selector:x,tags:!1,ajax:!1,placeholder:A,caseSensitive:!1,showSuggestions:!0,noSelectionString:D},G='autocomplete-setup-'+x;M.util.js_pending(G),'undefined'!=typeof y&&(F.tags=y),'undefined'!=typeof z&&(F.ajax=z),'undefined'!=typeof B&&(F.caseSensitive=B),'undefined'!=typeof C&&(F.showSuggestions=C),'undefined'==typeof D&&c.get_string('noselection','form').done(function(Q){F.noSelectionString=Q}).fail(f.exception);var H=a(x);if(!H)return b.debug('Selector not found: '+x),M.util.js_complete(G),!1;H.css('visibility','hidden').attr('aria-hidden',!0);var I={selectId:H.attr('id'),inputId:'form_autocomplete_input-'+h,suggestionsId:'form_autocomplete_suggestions-'+h,selectionId:'form_autocomplete_selection-'+h,downArrowId:'form_autocomplete_downarrow-'+h};h++,F.multiple=H.attr('multiple'),F.closeSuggestionsOnSelect='undefined'==typeof E?!F.multiple:E;var J=a('[for='+I.selectId+']'),K=[];H.children('option').each(function(Q,R){K[Q]={label:R.innerHTML,value:a(R).attr('value')}});var L=a.extend({},F,I);L.options=K,L.items=[];var N=d.render('core/form_autocomplete_input',L),O=d.render('core/form_autocomplete_suggestions',L),P=d.render('core/form_autocomplete_selection',L);return a.when(N,O,P).then(function(Q,R,S){H.hide(),H.after(R),H.after(Q),H.after(S),J.attr('for',I.inputId),w(F,I,H);var T=a(document.getElementById(I.suggestionsId));return T.hide().attr('aria-hidden',!0),j(F,I,H),M.util.js_complete(G),!0}).fail(function(Q){M.util.js_complete(G),f.exception(Q)})}}});